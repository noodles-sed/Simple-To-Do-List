<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>To-Do List â€” Enhanced</title>
    <link rel="icon" type="image/png" href="./assests/favicon.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
      :root{
        --glass-alpha: 0.18;
        --card-radius: 14px;
        --transition-fast: 200ms;
        --transition-med: 350ms;
      }

      /* Reset / base */
      * {box-sizing: border-box}
      html,body {height:100%}
      body {
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        margin:0;
        padding:0;
        -webkit-font-smoothing:antialiased;
        -moz-osx-font-smoothing:grayscale;
        color: #0f172a;
        min-height:100vh;
        display:flex;
        align-items:center;
        justify-content:center;
        background: radial-gradient(1200px 600px at 10% 10%, rgba(255,255,255,0.06), transparent),
                    radial-gradient(900px 400px at 90% 90%, rgba(255,255,255,0.035), transparent);
        overflow-x:hidden;
      }

      /* Animated gradient background wrapper */
      .bg-animated {
        position:fixed;
        inset:0;
        z-index:-3;
        background: linear-gradient(120deg, #93c5fd 0%, #a7f3d0 30%, #ddd6fe 60%, #fef3c7 100%);
        background-size: 300% 300%;
        animation: bgShift 18s linear infinite;
        filter: saturate(1.02);
      }
      @keyframes bgShift {
        0% { background-position: 0% 50% }
        50% { background-position: 100% 50% }
        100% { background-position: 0% 50% }
      }

      /* Particles container (lightweight) */
      #particlesContainer {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: -2;
        overflow: hidden;
      }
      .particle {
        position: absolute;
        border-radius: 999px;
        opacity: 0.12;
        transform: translate3d(0,0,0);
        animation: floatUp linear infinite;
      }
      @keyframes floatUp {
        from { transform: translateY(10px) scale(1); opacity: 0.08 }
        50% { opacity: 0.18; transform: translateY(-8px) scale(1.08) }
        to { transform: translateY(12px) scale(1); opacity: 0.06 }
      }

      /* Mouse trail */
      .mouse-particle {
        position: fixed;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        pointer-events: none;
        filter: blur(6px);
        opacity: 0.25;
        transform: translate(-50%,-50%);
        animation: fadeTrail 600ms linear forwards;
        z-index: 1000;
      }
      @keyframes fadeTrail {
        from { opacity: 0.5; transform: translate(-50%,-50%) scale(1) }
        to { opacity: 0; transform: translate(-50%,-50%) scale(2) }
      }

      /* Main container card */
      .card {
        width: min(980px, calc(100% - 40px));
        margin: 76px auto;
        border-radius: var(--card-radius);
        padding: 20px;
        box-shadow: 0 10px 30px rgba(2,6,23,0.12), inset 0 1px 0 rgba(255,255,255,0.02);
        backdrop-filter: blur(8px) saturate(1.05);
        background: linear-gradient(180deg, rgba(255,255,255,0.68), rgba(255,255,255,0.6));
        border: 1px solid rgba(255,255,255,0.45);
        position: relative;
        z-index: 10;
      }

      /* dark card variant */
      .glass-dark.card {
        background: linear-gradient(180deg, rgba(10,14,20,0.72), rgba(14,19,26,0.7));
        border: 1px solid rgba(255,255,255,0.06);
        color: #e6eef8;
        box-shadow: 0 12px 40px rgba(2,6,23,0.45);
      }

      header {
        position: fixed;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 40;
        width: min(980px, calc(100% - 40px));
        display:flex;
        justify-content:flex-end;
        gap:12px;
        align-items:center;
        pointer-events:auto;
      }

      .btn {
        padding: 2px 20px;
        border-radius: 999px;
        font-weight:600;
        letter-spacing:0.2px;
        display:inline-flex;
        align-items:center;
        gap:8px;
        border: 0;
        cursor:pointer;
        transition: all var(--transition-fast) ease;
      }
      .btn:focus { outline: 3px solid rgba(59,130,246,0.18); outline-offset: 3px; }

      .btn-primary {
        background: linear-gradient(90deg, rgba(59,130,246,1), rgba(99,102,241,1));
        color:white;
        box-shadow: 0 8px 24px rgba(59,130,246,0.12);
      }
      .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 14px 36px rgba(59,130,246,0.16) }

      /* header small icon buttons */
      .icon-btn {
        background: rgba(255,255,255,0.85);
        padding: 8px;
        border-radius: 10px;
        box-shadow: 0 4px 14px rgba(2,6,23,0.06);
        display:inline-flex;
        align-items:center;
        justify-content:center;
      }
      .glass-dark .icon-btn { background: rgba(255,255,255,0.04) }

      /* Title */
      .title {
        display:flex;
        gap:10px;
        align-items:center;
      }
      .title h1 { font-size: 28px; margin:0; font-weight:700; color: #0b1220 }

      /* form input styles (glass) */
      .glass-task, .task-item .task-edit-input, input[type="text"], select {
        background: rgba(255,255,255,0.65);
        border: 1px solid rgba(255,255,255,0.6);
      }
      .glass-dark .glass-task, .glass-dark input[type="text"], .glass-dark select {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.06);
      }

      input[type="text"], select {
        padding: 12px 14px;
        border-radius: 12px;
        width:100%;
        font-size: 14px;
        transition: box-shadow var(--transition-fast), transform var(--transition-fast);
      }
      input[type="text"]:focus, select:focus {
        outline: none;
        box-shadow: 0 6px 18px rgba(59,130,246,0.12);
        transform: translateY(-1px);
      }

      /* Search input */
      #searchInput { padding-left: 14px }

      /* task list */
      #taskList { margin: 6px 0 0 0; padding:0; list-style:none; display:flex; flex-direction:column; gap:12px; }
      .task-item {
        display:flex;
        gap:12px;
        align-items:center;
        justify-content:space-between;
        padding:14px;
        border-radius:12px;
        transition: transform var(--transition-med) ease, box-shadow var(--transition-med), opacity var(--transition-fast);
        background: rgba(255,255,255,0.9);
        border: 1px solid rgba(12,18,30,0.04);
        box-shadow: 0 6px 18px rgba(12,18,30,0.04);
        cursor: default;
      }
      .glass-dark .task-item {
        background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
        border: 1px solid rgba(255,255,255,0.03);
        box-shadow: 0 8px 24px rgba(2,6,23,0.45);
      }
      .task-item:hover { transform: translateY(-6px); box-shadow: 0 16px 40px rgba(2,6,23,0.08) }

      /* Task Editing Styles */
      .task-item.editing {
          background: rgba(255,255,255,0.95); /* Slightly brighter background when editing */
          flex-direction: column; /* Stack elements when editing */
          align-items: flex-start;
          transform: none !important;
      }
      .glass-dark .task-item.editing {
          background: rgba(255,255,255,0.05);
      }
      .task-item.editing > div:first-child { /* Hide the original text/badges container */
          display: none;
      }
      .task-item .edit-form-container {
          display: none; /* Initially hide the edit form */
          width: 100%;
      }
      .task-item.editing .edit-form-container {
          display: block; /* Show the edit form when editing */
      }


      .task-text { font-weight: 600; color: #0b1220; }
      .task-text.completed { text-decoration: line-through; color: #8b9bb6; font-weight:500; opacity:0.85 }

      .badges { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
      .badge { font-size:12px; padding:6px 8px; border-radius:999px; font-weight:600; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.03) }

      /* priority and category custom styling */
      .category-personal { background:#e6f0ff; color:#0f172a }
      .category-work { background:#f3e8ff; color:#5b21b6 }
      .category-shopping { background:#fff0f6; color:#9d174d }
      .category-health { background:#ecfdf5; color:#065f46 }

      .priority-low { background:#d1fae5; color:#064e3b }
      .priority-medium { background:#fef3c7; color:#92400e }
      .priority-high { background:#fee2e2; color:#991b1b }

      /* task action buttons */
      .action-btn { background:transparent; border:0; cursor:pointer; padding:6px; border-radius:8px; transition: background var(--transition-fast) }
      .action-btn:hover { background: rgba(0,0,0,0.04) }

      /* enter & exit animations */
      .task-enter { animation: taskIn 320ms cubic-bezier(.2,.9,.2,1) both; }
      .task-exit { animation: taskOut 280ms cubic-bezier(.4,.0,.2,1) both; }
      @keyframes taskIn {
        from { opacity:0; transform: translateY(-12px) scale(.995) }
        to { opacity:1; transform: translateY(0) scale(1) }
      }
      @keyframes taskOut {
        from { opacity:1; transform: translateX(0) }
        to { opacity:0; transform: translateX(-18px) scale(.98) }
      }

      /* floating Add button */
      .fab {
        position: fixed;
        right: 22px;
        bottom: 26px;
        z-index: 60;
        width: 64px;
        height: 64px;
        border-radius: 999px;
        display:flex;
        align-items:center;
        justify-content:center;
        box-shadow: 0 12px 34px rgba(59,130,246,0.16);
        cursor:pointer;
        transition: transform var(--transition-fast), box-shadow var(--transition-fast);
        background: linear-gradient(90deg,#3b82f6,#7c3aed);
        color: #fff;
        border: 0;
      }
      .fab:active { transform: translateY(1px) scale(.995) }
      .fab:focus { outline: 3px solid rgba(59,130,246,0.15); outline-offset: 4px; }

      /* ripple */
      .ripple {
        position:absolute;
        border-radius:50%;
        transform: translate(-50%,-50%);
        pointer-events:none;
        opacity:0.45;
        animation: rippleAnim 520ms cubic-bezier(.2,.8,.2,1) forwards;
      }
      @keyframes rippleAnim {
        from { transform: translate(-50%,-50%) scale(.2); opacity:0.45 }
        to { transform: translate(-50%,-50%) scale(3.2); opacity:0 }
      }

      /* achievement toast */
      #achievementBadge {
        position: fixed;
        left: 50%;
        transform: translateX(-50%) translateY(-16px);
        top: 18px;
        z-index:70;
        background: linear-gradient(90deg, rgba(255,255,255,0.9), rgba(255,255,255,0.8));
        color:#0b1220;
        padding: 10px 18px;
        border-radius: 10px;
        border: 1px solid rgba(0,0,0,0.06);
        box-shadow: 0 8px 30px rgba(2,6,23,0.08);
        transform-origin: top center;
        opacity:0;
        transition: transform 360ms cubic-bezier(.2,.9,.2,1), opacity 300ms;
        pointer-events:none;
      }
      .glass-dark #achievementBadge { background: rgba(255,255,255,0.02); color:#e6eef8; border:1px solid rgba(255,255,255,0.04) }
      #achievementBadge.show { transform: translateX(-50%) translateY(0); opacity:1 }

      /* stats panel and export panel */
      .panel {
        position: fixed;
        right: 20px;
        top: 88px;
        width: 300px;
        padding: 12px;
        border-radius: 12px;
        background: rgba(255,255,255,0.9);
        box-shadow: 0 12px 30px rgba(2,6,23,0.08);
        border: 1px solid rgba(255,255,255,0.6);
        transform: translateY(-8px);
        opacity:0;
        pointer-events:none;
        transition: all var(--transition-med) cubic-bezier(.2,.9,.2,1);
        z-index: 60;
      }
      .panel.show { transform: translateY(0); opacity:1; pointer-events:auto }
      .glass-dark .panel { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.04); color:#e8f2ff }

      /* progress bar */
      .progress-bar { background: #e6eef8; border-radius: 999px; height:10px; overflow:hidden }
      .progress-fill { height:100%; width:0%; background: linear-gradient(90deg,#3b82f6,#7c3aed); transition: width 450ms cubic-bezier(.2,.9,.2,1) }

      /* custom scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-thumb { background: rgba(12,18,30,0.08); border-radius:999px }
      ::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); border-radius:999px }

      /* responsive tweaks */
      @media (max-width: 720px) {
        .card { padding: 16px; margin: 80px 12px; }
        header { left:12px; right:12px; transform:none; width: auto; justify-content:flex-end }
        .title h1 { font-size:20px }
        .fab { right:14px; bottom:14px; width:56px; height:56px }
        .panel { width: calc(100% - 28px); right:14px; top:84px }
      }
    </style>
  </head>

  <body class="theme-blue">
    <div class="bg-animated" aria-hidden="true"></div>
    <div id="particlesContainer" aria-hidden="true"></div>

    <header>
      <div class="auth-buttons" style="display:flex; gap:8px;">
        <a href="login.html" class="btn btn-primary">Login</a>
        <a href="signup.html" class="btn icon-btn" title="Signup">Signup</a>
      </div>
    </header>

    <div id="achievementBadge" role="status" aria-live="polite"></div>

    <aside id="statsPanel" class="panel" aria-hidden="true">
      <h3 class="text-sm font-semibold mb-2">Statistics</h3>
      <div class="text-xs text-gray-600 mb-2">Completed: <strong id="statsCompleted">0</strong></div>
      <div class="text-xs text-gray-600 mb-2">Score: <strong id="statsScore">0%</strong></div>
      <div class="text-xs text-gray-600">Streak: <strong id="statsStreak">0 days</strong></div>
    </aside>

    <aside id="exportPanel" class="panel" aria-hidden="true" style="top: 200px;">
      <h3 class="text-sm font-semibold mb-2">Export / Import</h3>
      <div class="flex gap-2">
        <button id="exportTasks" class="btn btn-primary w-full">Export</button>
        <button id="importTasks" class="btn" style="background:transparent; border:1px solid rgba(12,18,30,0.06);">Import</button>
      </div>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <div class="text-xs text-gray-500 mt-3">You can export your tasks to a JSON file or import a previously saved list.</div>
    </aside>

    <main class="card glass" role="main" aria-labelledby="main-title">
      <div class="flex items-start justify-between mb-3">
        <div>
          <div class="title mb-2">
            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 12l2 2 4-4" stroke="#2563EB" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <h1 id="main-title">To-Do List</h1>
          </div>
          <div class="text-sm text-gray-600">Plan your day, track progress, and earn achievements.</div>
        </div>

        <div class="hidden md:flex items-center gap-2">
          <button id="statsToggle" class="icon-btn" title="Statistics">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M3 3v18h18" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>

          <button id="exportToggle" class="icon-btn" title="Export / Import">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M12 5v14" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 12h-14" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>

          <div class="relative">
            <button id="themeToggle" class="icon-btn" title="Theme">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M12 3v2" stroke="currentColor" stroke-width="1.4"/><path d="M12 19v2" stroke="currentColor" stroke-width="1.4"/><path d="M4.2 4.2l1.4 1.4" stroke="currentColor" stroke-width="1.4"/><path d="M18.4 18.4l1.4 1.4" stroke="currentColor" stroke-width="1.4"/></svg>
            </button>
            <div id="themeDropdown" class="hidden absolute right-0 mt-2 w-44 bg-white rounded-lg shadow-lg py-2 z-10">
              <button data-theme="blue" class="theme-option flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                <span class="w-3 h-3 rounded-full bg-blue-500 mr-3"></span>Blue
              </button>
              <button data-theme="green" class="theme-option flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                <span class="w-3 h-3 rounded-full bg-green-500 mr-3"></span>Green
              </button>
              <button data-theme="purple" class="theme-option flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                <span class="w-3 h-3 rounded-full bg-purple-500 mr-3"></span>Purple
              </button>
              <button data-theme="dark" class="theme-option flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                <span class="w-3 h-3 rounded-full bg-slate-800 mr-3"></span>Dark
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between mb-4 gap-4">
        <div class="text-sm text-gray-600"><span id="completedCount">0</span> of <span id="totalCount">0</span> tasks completed</div>
        <div class="w-36">
          <div class="progress-bar" aria-hidden="true">
            <div id="progressFill" class="progress-fill" style="width:0%"></div>
          </div>
        </div>
      </div>

      <section class="mb-4 space-y-4">
        <div class="flex gap-3 items-start">
          <input id="taskInput" type="text" placeholder="Add a new task..." aria-label="Task" />
          <button id="addTaskBtn" class="btn btn-primary" aria-label="Add task">Add Task</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-xs font-medium text-gray-500 mb-1 block">Category</label>
            <select id="categorySelect" aria-label="Category">
              <option value="personal">Personal</option>
              <option value="work">Work</option>
              <option value="shopping">Shopping</option>
              <option value="health">Health</option>
            </select>
          </div>

          <div>
            <label class="text-xs font-medium text-gray-500 mb-1 block">Priority</label>
            <select id="prioritySelect" aria-label="Priority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>

          <div>
            <label class="text-xs font-medium text-gray-500 mb-1 block">Due Date</label>
            <input id="dueDateInput" type="text" placeholder="Select date" aria-label="Due date"/>
          </div>
        </div>
      </section>

      <div class="mb-4">
        <input id="searchInput" type="text" placeholder="Search tasks, category, priority or date..." aria-label="Search" />
      </div>

      <div>
        <ul id="taskList" aria-live="polite"></ul>

        <div id="noResults" class="text-center py-8 hidden text-gray-500">
          <svg class="w-16 h-16 mx-auto mb-2" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <p>No matching tasks</p>
        </div>

        <div id="emptyState" class="text-center py-12 text-gray-500 hidden">
          <svg class="w-24 h-24 mx-auto mb-4" viewBox="0 0 24 24" fill="none"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <p>No tasks yet. Add one above!</p>
        </div>
      </div>
    </main>

    <button id="floatingAdd" class="fab" aria-label="Add Task (quick)">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>

    <script>
      /***************
       * Elements
       ***************/
      const taskInput = document.getElementById("taskInput");
      const addTaskBtn = document.getElementById("addTaskBtn");
      const taskList = document.getElementById("taskList");
      const categorySelect = document.getElementById("categorySelect");
      const prioritySelect = document.getElementById("prioritySelect");
      const dueDateInput = document.getElementById("dueDateInput");
      const themeToggle = document.getElementById("themeToggle");
      const themeDropdown = document.getElementById("themeDropdown");
      const progressFill = document.getElementById("progressFill");
      const completedCount = document.getElementById("completedCount");
      const totalCount = document.getElementById("totalCount");
      const emptyState = document.getElementById("emptyState");
      const searchInput = document.getElementById("searchInput");
      const noResults = document.getElementById("noResults");
      const achievementBadge = document.getElementById("achievementBadge");
      const particlesContainer = document.getElementById("particlesContainer");
      const fab = document.getElementById("floatingAdd");

      const statsToggle = document.getElementById("statsToggle");
      const exportToggle = document.getElementById("exportToggle");
      const statsPanel = document.getElementById("statsPanel");
      const exportPanel = document.getElementById("exportPanel");
      const exportTasksBtn = document.getElementById("exportTasks");
      const importTasksBtn = document.getElementById("importTasks");
      const importFile = document.getElementById("importFile");

      // flatpickr init
      flatpickr(dueDateInput, { dateFormat: "Y-m-d", minDate: "today" });

      // theme
      let currentTheme = localStorage.getItem("todoTheme") || 'blue';
      function applyTheme(theme) {
        currentTheme = theme;
        localStorage.setItem("todoTheme", theme);
        document.body.classList.remove('theme-blue','theme-green','theme-purple','theme-dark');
        document.body.classList.add('theme-'+theme);

        // dark card if needed
        const card = document.querySelector('.card');
        if (theme === 'dark') {
          card.classList.add('glass-dark');
        } else {
          card.classList.remove('glass-dark');
        }

        // adapt animated background palette subtly by CSS variable (fallback handled)
        switch(theme) {
          case 'blue': document.querySelector('.bg-animated').style.background = 'linear-gradient(120deg, #93c5fd 0%, #a7f3d0 30%, #ddd6fe 60%, #fef3c7 100%)'; break;
          case 'green': document.querySelector('.bg-animated').style.background = 'linear-gradient(120deg, #d1fae5 0%, #10b981 30%, #bbf7d0 60%, #fef3c7 100%)'; break;
          case 'purple': document.querySelector('.bg-animated').style.background = 'linear-gradient(120deg, #ddd6fe 0%, #8b5cf6 30%, #fbcfe8 60%, #fef3c7 100%)'; break;
          case 'dark': document.querySelector('.bg-animated').style.background = 'linear-gradient(120deg, #374151 0%, #1f2937 50%, #0f172a 100%)'; break;
        }

        // refresh particles colour
        particlesContainer.innerHTML = '';
        createParticles();
      }

      // theme dropdown wiring
      document.querySelectorAll('.theme-option').forEach(btn => {
        btn.addEventListener('click', () => {
          applyTheme(btn.dataset.theme);
          themeDropdown.classList.add('hidden');
        });
      });
      document.getElementById('themeToggle').addEventListener('click', (e) => {
        e.stopPropagation();
        themeDropdown.classList.toggle('hidden');
      });
      document.addEventListener('click', (e) => {
        if (!themeDropdown.contains(e.target)) themeDropdown.classList.add('hidden');
      });

      /***************
       * Progress & Storage
       ***************/
      function updateProgress() {
        const total = taskList.children.length;
        const done = document.querySelectorAll('.task-text.completed').length;
        const p = total > 0 ? Math.round((done/total)*100) : 0;
        progressFill.style.width = p + '%';
        completedCount.textContent = done;
        totalCount.textContent = total;

        if (total === 0) emptyState.classList.remove('hidden'); else emptyState.classList.add('hidden');

        if (p > 0) {
          progressFill.classList.add('pulse-animation');
          setTimeout(()=>progressFill.classList.remove('pulse-animation'), 450);
        }

        // update stats + achievements
        updateStats();
        checkAchievements();
      }

      function saveTasks() {
        const tasks = [];
        taskList.querySelectorAll('li').forEach(li => {
          // **CORRECTED: Read from data attributes, which are updated during edit**
          const text = li.dataset.text || li.querySelector('.task-text')?.textContent || '';
          const completed = li.dataset.completed === 'true';
          const category = li.dataset.category || 'personal';
          const priority = li.dataset.priority || 'medium';
          const dueDate = li.dataset.dueDate || '';
          
          tasks.push({ text, completed, category, priority, dueDate });
        });
        localStorage.setItem('todoListTasks', JSON.stringify(tasks));
        updateProgress();
      }

      /***************
       * Create Task
       ***************/
      function createTask(taskText, isCompleted=false, category='personal', priority='medium', dueDate='') {
        const li = document.createElement('li');
        li.className = 'task-item task-enter';
        // **NEW: Store task data on the element for easy access/saving**
        li.dataset.text = taskText;
        li.dataset.completed = isCompleted;
        li.dataset.category = category;
        li.dataset.priority = priority;
        li.dataset.dueDate = dueDate;

        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'task-content-wrapper'; // New wrapper for content
        contentWrapper.style.flex = '1';
        contentWrapper.style.display = 'flex';
        contentWrapper.style.flexDirection = 'column';

        const span = document.createElement('span');
        span.className = 'task-text';
        span.textContent = taskText;
        if (isCompleted) span.classList.add('completed');

        const badges = document.createElement('div');
        badges.className = 'badges mt-2';

        const cat = document.createElement('span');
        cat.className = `badge category-badge category-${category}`;
        cat.dataset.category = category;
        cat.textContent = category.charAt(0).toUpperCase() + category.slice(1);

        const pr = document.createElement('span');
        pr.className = `badge priority-badge priority-${priority}`;
        pr.dataset.priority = priority;
        pr.textContent = priority.charAt(0).toUpperCase() + priority.slice(1);

        badges.appendChild(cat);
        badges.appendChild(pr);

        if (dueDate) {
          const d = document.createElement('span');
          d.className = 'badge due-date';
          d.textContent = dueDate;
          badges.appendChild(d);
        }

        contentWrapper.appendChild(span);
        contentWrapper.appendChild(badges);

        // **NEW: Edit Form Container (initially hidden)**
        const editFormContainer = document.createElement('div');
        editFormContainer.className = 'edit-form-container';
        // Content will be added by toggleEditMode(li, true)

        // actions
        const actions = document.createElement('div');
        actions.className = 'task-actions';
        actions.style.display = 'flex';
        actions.style.alignItems = 'center';
        actions.style.gap = '8px';

        const editBtn = document.createElement('button');
        editBtn.className = 'action-btn edit-btn';
        editBtn.innerHTML = '<svg class="edit-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15.232 5.232l3.536 3.536M9 21h6" stroke="#0b1220" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        editBtn.title = 'Edit';
        // Pass 'li' to the toggleEditMode function on click
        editBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleEditMode(li); });

        const delBtn = document.createElement('button');
        delBtn.className = 'action-btn delete-btn';
        delBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6M10 11v6M14 11v6" stroke="#0b1220" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        delBtn.title = 'Delete';
        delBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          li.classList.add('task-exit');
          playSound('delete');
          setTimeout(()=>{ if(li.parentNode) { li.parentNode.removeChild(li); saveTasks(); } }, 300);
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        // toggle complete on text click
        li.addEventListener('click', (e) => {
          // Prevent toggling if in editing mode or a button/input was clicked
          if (li.classList.contains('editing') || e.target.closest('button, input, select')) return; 
          
          li.dataset.completed = li.dataset.completed === 'false' ? 'true' : 'false';
          span.classList.toggle('completed');
          span.classList.add('pulse-animation');
          setTimeout(()=>span.classList.remove('pulse-animation'), 450);
          saveTasks();
          // sound
          if (span.classList.contains('completed')) playSound('complete');
        });

        li.appendChild(contentWrapper);
        li.appendChild(editFormContainer); // Add the hidden form container
        li.appendChild(actions);

        // drag & drop
        makeTaskDraggable(li);

        taskList.appendChild(li);

        // remove enter class
        setTimeout(()=>li.classList.remove('task-enter'), 320);

        // apply current theme glass (if dark)
        const card = document.querySelector('.card');
        if (currentTheme === 'dark') li.classList.add('glass-dark');

        updateProgress();
      }

      /***************
       * Toggle Edit Mode - REFINED LOGIC
       ***************/
      function toggleEditMode(li) {
        const editing = li.classList.contains('editing');
        const actions = li.querySelector('.task-actions');
        const editFormContainer = li.querySelector('.edit-form-container');
        const editButton = li.querySelector('.edit-btn');

        if (!editing) {
          // --- ENTER EDIT MODE ---
          li.classList.add('editing');
          
          // Clear and build the edit form inside the container
          editFormContainer.innerHTML = ''; 
          editFormContainer.innerHTML = `
              <div class="space-y-3 p-1 w-full">
                  <input type="text" class="task-edit-input" value="${li.dataset.text}" placeholder="Task description" />
                  <div class="grid grid-cols-3 gap-2 text-xs">
                      <select class="task-edit-category" aria-label="Category">
                          ${Array.from(categorySelect.options).map(opt => `<option value="${opt.value}" ${opt.value === li.dataset.category ? 'selected' : ''}>${opt.textContent}</option>`).join('')}
                      </select>
                      <select class="task-edit-priority" aria-label="Priority">
                          ${Array.from(prioritySelect.options).map(opt => `<option value="${opt.value}" ${opt.value === li.dataset.priority ? 'selected' : ''}>${opt.textContent}</option>`).join('')}
                      </select>
                      <input type="text" class="task-edit-duedate" value="${li.dataset.dueDate}" placeholder="Due date"/>
                  </div>
                  <div class="flex justify-end gap-2 pt-2">
                      <button class="btn btn-sm btn-cancel" style="background: #f1f5f9; color: #475569; padding:8px 16px;">Cancel</button>
                      <button class="btn btn-sm btn-save btn-primary" style="padding:8px 16px;">Save</button>
                  </div>
              </div>
          `;
          
          // Re-init flatpickr for the new date input
          const dateInput = editFormContainer.querySelector('.task-edit-duedate');
          flatpickr(dateInput, { dateFormat: "Y-m-d", minDate: "today" });
          
          // Change the right-side buttons to Save/Cancel actions
          actions.innerHTML = `
              <button class="action-btn save-edit-btn" title="Save"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M5 13l4 4L19 7" stroke="#3b82f6" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
              <button class="action-btn cancel-edit-btn" title="Cancel"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="#ef4444" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
          `;
          
          // Add event listeners for the new action buttons
          li.querySelector('.save-edit-btn').addEventListener('click', () => saveEditMode(li));
          li.querySelector('.cancel-edit-btn').addEventListener('click', () => toggleEditMode(li)); // Just toggle back
          
          // Add 'Enter' key listener to the text input for quick save
          const textInput = editFormContainer.querySelector('.task-edit-input');
          textInput.addEventListener('keydown', (e) => { 
              if (e.key === 'Enter') { e.preventDefault(); saveEditMode(li); } 
          });

          textInput.focus();

        } else {
          // --- EXIT EDIT MODE (via Cancel or after Save) ---
          li.classList.remove('editing');

          // Re-populate original action buttons
          actions.innerHTML = '';
          actions.appendChild(editButton);
          
          const delBtn = document.createElement('button');
          delBtn.className = 'action-btn delete-btn';
          delBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6M10 11v6M14 11v6" stroke="#0b1220" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          delBtn.title = 'Delete';
          delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            li.classList.add('task-exit');
            playSound('delete');
            setTimeout(()=>{ if(li.parentNode) { li.parentNode.removeChild(li); saveTasks(); } }, 300);
          });
          actions.appendChild(delBtn);

          // Restore original task content wrapper (hidden by CSS in edit mode)
          li.querySelector('.task-content-wrapper').style.display = 'flex';
          
          // Clear the form container
          editFormContainer.innerHTML = '';
        }
      }

      /***************
       * Save Edit Mode - NEW FUNCTION
       ***************/
      function saveEditMode(li) {
          const textInput = li.querySelector('.task-edit-input');
          const categoryEdit = li.querySelector('.task-edit-category');
          const priorityEdit = li.querySelector('.task-edit-priority');
          const dateInput = li.querySelector('.task-edit-duedate');

          // Validation
          const newText = textInput.value.trim();
          if (newText === "") {
              alert("Task text cannot be empty.");
              return; 
          }

          // 1. UPDATE DATA ATTRIBUTES
          li.dataset.text = newText;
          li.dataset.category = categoryEdit.value;
          li.dataset.priority = priorityEdit.value;
          li.dataset.dueDate = dateInput.value;

          // 2. REFRESH VISUALS
          const span = li.querySelector('.task-text');
          span.textContent = newText;
          
          const categoryBadge = li.querySelector('.category-badge');
          categoryBadge.textContent = categoryEdit.value.charAt(0).toUpperCase() + categoryEdit.value.slice(1);
          categoryBadge.className = `badge category-badge category-${categoryEdit.value}`;

          const priorityBadge = li.querySelector('.priority-badge');
          priorityBadge.textContent = priorityEdit.value.charAt(0).toUpperCase() + priorityEdit.value.slice(1);
          priorityBadge.className = `badge priority-badge priority-${priorityEdit.value}`;
          
          // Due Date Badge handling (create or update)
          let dueDateBadge = li.querySelector('.due-date');
          if (dateInput.value) {
              if (!dueDateBadge) {
                  dueDateBadge = document.createElement('span');
                  dueDateBadge.className = 'badge due-date';
                  li.querySelector('.badges').appendChild(dueDateBadge);
              }
              dueDateBadge.textContent = dateInput.value;
          } else if (dueDateBadge) {
              dueDateBadge.remove();
          }

          // 3. EXIT MODE AND SAVE
          toggleEditMode(li); // Exit editing mode
          saveTasks(); // Persist changes
          playSound('theme'); // Use a sound for success
          showAchievement('âœ… Task Updated!');
      }

      /***************
       * Add Task Handling
       ***************/
      function handleAddTask() {
        const text = taskInput.value.trim();
        if (!text) return;
        
        // Pass the actual date string from flatpickr, not the input value
        const dueDateValue = dueDateInput._flatpickr?.selectedDates[0] ? dueDateInput.value : '';

        createTask(text, false, categorySelect.value, prioritySelect.value, dueDateValue);
        saveTasks();
        playSound('add');

        // clear inputs & focus
        taskInput.value = '';
        dueDateInput._flatpickr?.clear(); // nice to clear flatpickr
        categorySelect.value = 'personal';
        prioritySelect.value = 'medium';
        taskInput.focus();

        // small microinteraction on fab
        fabAnimateRipple();
      }
      addTaskBtn.addEventListener('click', handleAddTask);
      taskInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') handleAddTask(); });

      // floating fab quick add (will focus input)
      fab.addEventListener('click', (e)=>{ taskInput.focus(); taskInput.classList.add('pulse-animation'); setTimeout(()=>taskInput.classList.remove('pulse-animation'),450); fabAnimateRipple(e); });
      function fabAnimateRipple(e){
        const r = document.createElement('div');
        r.className = 'ripple';
        const rect = fab.getBoundingClientRect();
        const x = rect.width/2; const y = rect.height/2;
        r.style.left = x + 'px'; r.style.top = y + 'px';
        r.style.width = r.style.height = Math.max(rect.width, rect.height) + 'px';
        fab.appendChild(r);
        setTimeout(()=>{ if(r.parentNode) r.parentNode.removeChild(r); }, 600);
      }

      /***************
       * Drag & Drop
       ***************/
      let dragged=null;
      function makeTaskDraggable(li) {
        li.draggable = true;
        li.addEventListener('dragstart', (e)=>{ dragged = li; li.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
        li.addEventListener('dragend', ()=>{ if(dragged) dragged.classList.remove('dragging'); dragged=null; saveTasks(); });
        li.addEventListener('dragover', function(e){ e.preventDefault(); });
        li.addEventListener('drop', function(e){
          e.preventDefault();
          if (!dragged || dragged === li) return;
          const rect = li.getBoundingClientRect();
          const mid = rect.top + rect.height/2;
          if (e.clientY < mid) taskList.insertBefore(dragged, li);
          else taskList.insertBefore(dragged, li.nextSibling);
        });
      }

      /***************
       * Search / Filter
       ***************/
      function runSearchFilter(query){
        const q = String(query || '').trim().toLowerCase();
        let visible=0;
        const total = taskList.children.length;
        Array.from(taskList.children).forEach(li=>{
          // Use data attributes for filtering
          const hay = [
            li.dataset.text || '',
            li.dataset.category || '',
            li.dataset.priority || '',
            li.dataset.dueDate || ''
          ].join(' ').toLowerCase();
          const match = q === '' || hay.indexOf(q) !== -1;
          li.style.display = match ? '' : 'none';
          if (match) visible++;
        });
        if (total === 0) { if (emptyState) emptyState.classList.remove('hidden'); if(noResults) noResults.classList.add('hidden'); return; } else { if (emptyState) emptyState.classList.add('hidden'); }
        if (visible === 0 && q !== '') { noResults.classList.remove('hidden'); } else { noResults.classList.add('hidden'); }
      }
      searchInput.addEventListener('input', (e)=> runSearchFilter(e.target.value));

      /***************
       * Export / Import
       ***************/
      function exportTasks(){
        const tasks = [];
        taskList.querySelectorAll('li').forEach(li=>{
          tasks.push({
            text: li.dataset.text || '',
            completed: li.dataset.completed === 'true',
            category: li.dataset.category || 'personal',
            priority: li.dataset.priority || 'medium',
            dueDate: li.dataset.dueDate || ''
          });
        });
        const blob = new Blob([JSON.stringify(tasks, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'todo-tasks.json';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      }
      exportTasksBtn.addEventListener('click', exportTasks);
      importTasksBtn.addEventListener('click', ()=> importFile.click());
      importFile.addEventListener('change', (e)=>{
        const file = e.target.files[0]; if(!file) return;
        const r = new FileReader();
        r.onload = function(evt){
          try {
            const tasks = JSON.parse(evt.target.result);
            taskList.innerHTML = '';
            tasks.forEach(t => createTask(t.text, t.completed, t.category, t.priority, t.dueDate));
            saveTasks();
            showAchievement('ðŸ“ Tasks Imported!');
          } catch (err) { alert('Import failed - invalid file.'); }
        };
        r.readAsText(file);
      });

      /***************
       * Panels toggles and keyboard
       ***************/
      function toggleStats(){ statsPanel.classList.toggle('show'); updateStats(); }
      function toggleExport(){ exportPanel.classList.toggle('show'); }
      statsToggle?.addEventListener('click', toggleStats);
      exportToggle?.addEventListener('click', toggleExport);

      document.addEventListener('keydown', (e)=>{
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); taskInput.focus(); }
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') { e.preventDefault(); searchInput.focus(); }
        if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); toggleStats(); }
      });

      /***************
       * Achievements + Stats + Sounds
       ***************/
      let achievements = JSON.parse(localStorage.getItem('achievements') || '[]');
      let stats = JSON.parse(localStorage.getItem('userStats') || '{"completed":0,"streak":0}');
      function showAchievement(text){
        achievementBadge.textContent = text;
        achievementBadge.classList.add('show');
        setTimeout(()=>achievementBadge.classList.remove('show'),3000);
      }
      function checkAchievements(){
        const total = taskList.children.length;
        const done = document.querySelectorAll('.task-text.completed').length;
        const newAch = [];
        if (done >= 1 && !achievements.includes('first_task')) newAch.push({id:'first_task', text:'ðŸŽ‰ First Task Completed!'});
        if (done >= 10 && !achievements.includes('ten_tasks')) newAch.push({id:'ten_tasks', text:'ðŸ”¥ 10 Tasks Completed!'});
        if (done >= 50 && !achievements.includes('fifty_tasks')) newAch.push({id:'fifty_tasks', text:'ðŸ† 50 Tasks Completed!'});
        if (total > 0 && done === total && !achievements.includes('all_done')) newAch.push({id:'all_done', text:'ðŸŽŠ All Tasks Completed!'});
        newAch.forEach(a => { achievements.push(a.id); showAchievement(a.text); if(a.id === 'all_done') createConfetti(); });
        if (newAch.length) localStorage.setItem('achievements', JSON.stringify(achievements));
      }
      function updateStats(){
        const done = document.querySelectorAll('.task-text.completed').length;
        const total = taskList.children.length;
        const score = total > 0 ? Math.round((done/total)*100):0;
        stats.completed = done; stats.productivityScore = score;
        const today = new Date().toDateString(); const lastActive = localStorage.getItem('lastActive');
        if (lastActive !== today) {
          if (done>0) stats.streak=(stats.streak||0)+1; else stats.streak=0;
          localStorage.setItem('lastActive', today);
        }
        localStorage.setItem('userStats', JSON.stringify(stats));
        document.getElementById('statsCompleted').textContent = done;
        document.getElementById('statsScore').textContent = score+'%';
        document.getElementById('statsStreak').textContent = (stats.streak||0) + ' days';
      }

      // sounds: succinct WebAudio beeps
      function playSound(type){
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.connect(g); g.connect(ctx.destination);
          let freq = 450;
          if (type === 'complete') freq = 880;
          if (type === 'delete') freq = 220;
          if (type === 'add') freq = 520;
          if (type === 'theme') freq = 360; // Using 'theme' for general update sound
          o.type = 'sine';
          o.frequency.value = freq;
          g.gain.value = 0.06;
          o.start();
          o.stop(ctx.currentTime + 0.12);
          g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.12);
        } catch(err){ /* ignore */ }
      }

      /***************
       * Confetti
       ***************/
      function createConfetti(){
        const colors = ['#f39c12','#e74c3c','#3498db','#2ecc71','#9b59b6'];
        const count = 40;
        for (let i=0;i<count;i++){
          const el = document.createElement('div');
          el.className = 'confetti';
          el.style.position = 'fixed';
          el.style.left = Math.random()*100 + '%';
          el.style.top = '-10%';
          el.style.width = (6+Math.random()*8)+'px';
          el.style.height = (10+Math.random()*12)+'px';
          el.style.background = colors[Math.floor(Math.random()*colors.length)];
          el.style.transform = 'rotate('+(Math.random()*360)+'deg)';
          el.style.zIndex = 90;
          el.style.pointerEvents = 'none';
          el.style.opacity = 0.95;
          el.style.borderRadius = '2px';
          el.style.transition = 'transform 2600ms cubic-bezier(.2,.9,.2,1), top 2600ms linear, opacity 2600ms linear';
          document.body.appendChild(el);
          requestAnimationFrame(()=> {
            el.style.top = (60 + Math.random()*50) + '%';
            el.style.transform = 'rotate('+(Math.random()*720 - 360)+'deg) translateX('+(Math.random()*160 - 80)+'px)';
            el.style.opacity = 0;
          });
          setTimeout(()=> el.remove(), 2800);
        }
      }

      /***************
       * Particles + Mouse Trail
       ***************/
      function createParticles() {
        const count = 28;
        for (let i=0;i<count;i++){
          const p = document.createElement('div');
          p.className='particle';
          const size = 4 + Math.random()*10;
          p.style.width = p.style.height = size + 'px';
          p.style.left = Math.random()*100 + '%';
          p.style.top = Math.random()*100 + '%';
          p.style.animationDuration = (8 + Math.random()*14) + 's';
          // color based on theme
          let palette;
          if (currentTheme === 'dark') palette = ['rgba(255,255,255,0.18)','rgba(255,255,255,0.12)'];
          else palette = ['rgba(59,130,246,0.12)','rgba(16,185,129,0.09)','rgba(139,92,246,0.09)'];
          p.style.background = palette[Math.floor(Math.random()*palette.length)];
          particlesContainer.appendChild(p);
        }
      }
      document.addEventListener('mousemove', (e) => {
        const node = document.createElement('div');
        node.className = 'mouse-particle';
        // subtle color
        node.style.background = currentTheme === 'dark' ? 'rgba(255,255,255,0.12)' : 'rgba(59,130,246,0.12)';
        node.style.left = e.clientX + 'px';
        node.style.top = e.clientY + 'px';
        document.body.appendChild(node);
        setTimeout(()=> node.remove(), 700);
      });

      /***************
       * Load / Init
       ***************/
      function loadTasks() {
        const loaded = JSON.parse(localStorage.getItem('todoListTasks') || '[]');
        loaded.forEach(t => createTask(t.text, t.completed, t.category, t.priority, t.dueDate));
        updateProgress();
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', ()=>{
        applyTheme(currentTheme);
        createParticles();
        loadTasks();

        // little welcome
        if ((JSON.parse(localStorage.getItem('achievements') || '[]')).length === 0) {
          setTimeout(()=> showAchievement('ðŸ‘‹ Welcome â€” ready to be productive!'), 800);
        }
      });

      /***************
       * small helpers & events
       ***************/
      // Save on unload
      window.addEventListener('beforeunload', saveTasks);

      // Close panels on outside click
      document.addEventListener('click', (e)=>{
        if (!statsPanel.contains(e.target) && !statsToggle.contains(e.target)) statsPanel.classList.remove('show');
        if (!exportPanel.contains(e.target) && !exportToggle.contains(e.target)) exportPanel.classList.remove('show');
      });

      // For touch / mobile, support quick add double-tap of fab
      let lastTap = 0;
      fab.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTap < 350) taskInput.focus();
        lastTap = now;
      });
    </script>
  </body>
</html>